---
title: H5与APP账号登录状态保持
toc: true
date: 2019-04-02 18:56:10
tags:
 - 笔记
categories:
 - openedx
---
本文主要是研究分析H5与APP账号绑定与登录状态同步问题，如有不妥，欢迎指出探讨。

### 1 登录状态技术分析
#### 1.1 H5登录状态
Open edX核心网站是LMS，所有功能都是围绕LMS进行开展和拓展的，LMS是个系统中心，其他系统的登录是通过LMS这个认证中心做OAuth认证，换取token，存储在本地以便每次请求携带。
而LMS本身的登录状态是使用 ***Cookies-Session*** 机制实现的(未来会使用 ***JWT*** 替代，首次替换貌似是I版还是J版)。

#### 1.2 APP登录状态
外部APP的登录状态，一般都是采用token的形式，也就是APP往认证中心提交认证信息，以换取其相应的认证凭证(token)并存储在本地，每次请求都必须带上token，以检验请求的合法性及有效性。

#### 1.3 实现方案
结合两者，以及目前市面上流行的做法(我所了解到的)过程如下：
1. APP(未登录)中，通过 WebView 打开H5页面(LMS)；
2. 通过header传递指定参数，隐藏APP中H5的登录入口**(可选)**；
3. APP登录后，通过 **AppId**、**AppSecert**、**username**、**时间戳** 加密生成 **Token**，追加到LMS的入口地址上；
4. 点击打开带 **Token** 的LMS，通过客户端类型、Cookie信息、Token信息进行验证与登录，登录后保存Cookie；
5. APP退出登录后，请求LMS接口，使Token失效，再次打开LMS时检验到Token失效时自动退出LMS登录；

#### 1.4 对接流程与工作
##### 1.4.1 平台
1. 新增一个中间件，顺序根据情况适当排前面，对H5入口URL进行特殊处理：
  - 是否APP-H5模式下允许的客户端(识别是来自APP发起的WebView)，是则下一步，否则403；
  - 是否携带合法、有效Token，是则下一步，否则403；
  - 是否存在Cookie且登录对象与Token匹配，是则下一步，否则更新登录用户；
2. 根据header参数，隐藏H5登录入口**(可选)**

##### 1.4.2 第三方
1. 与平台，获取其对应的AppID、AppSecert；
2. 根据规则，登录时调用LMS接口，认证身份并换取Token，附加到H5入口URL；
3. 根据规则，退出时请求LMS接口，让Token失效即可；

![](/media/editor/H5-APP时序图_20190306155411655051.jpg)

Ps. 以上对接方案会根据实际期望流程有所调整，但整体基本不变，需要注意的是，因为是添加中间件，需要理清中间件的处理顺序及存储的信息内容，否则容易造成的比较大范围的影响；




## 参考资料
> - []()
> - []()
